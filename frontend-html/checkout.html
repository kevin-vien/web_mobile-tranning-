<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Thanh toán - Web Mobile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      :root { --primary: #0d6efd; }
      body { background-color: #f8fafc; }
      .brand-text { color: #1d4ed8; }
      .product-card:hover { box-shadow: 0 6px 24px rgba(0,0,0,0.08); transform: translateY(-2px); }
      .product-card { transition: .2s ease; }
      .btn-cart { position: relative; }
      .btn-cart .badge { position: absolute; top: -6px; right: -6px; }
      .navbar { position: relative; }
      .navbar * { pointer-events: auto !important; }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top" style="z-index: 1030;">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <span class="rounded-circle bg-primary d-inline-block" style="width:28px;height:28px"></span>
          <span class="ms-2 fw-semibold brand-text">Web Mobile</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbars" aria-controls="navbars" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbars">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Trang chủ</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html#promo">Khuyến mãi</a></li>
                <li><a class="dropdown-item" href="index.html#new">Mới về</a></li>
                <li><a class="dropdown-item" href="index.html#top">Bán chạy</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Điện thoại</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html">Iphone</a></li>
                <li><a class="dropdown-item" href="index.html">Samsung</a></li>
                <li><a class="dropdown-item" href="index.html">Oppo</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Laptop</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html">Asus</a></li>
                <li><a class="dropdown-item" href="index.html">Dell</a></li>
                <li><a class="dropdown-item" href="index.html">Lenovo</a></li>
                <li><a class="dropdown-item" href="index.html">Macbook</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Phụ kiện</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html">Tai nghe</a></li>
                <li><a class="dropdown-item" href="index.html">Sạc</a></li>
                <li><a class="dropdown-item" href="index.html">Ốp lưng</a></li>
              </ul>
            </li>
          </ul>
          <div class="d-flex align-items-center gap-2">
            <form class="d-flex" role="search" onsubmit="window.location.href='index.html'; return false;">
              <input id="searchInput" class="form-control me-2" type="search" placeholder="Tìm kiếm..." aria-label="Search">
              <button class="btn btn-primary" type="button" onclick="window.location.href='index.html'">Tìm</button>
            </form>
            <button class="btn btn-outline-secondary btn-cart" type="button" data-bs-toggle="offcanvas" data-bs-target="#cartPanel" aria-controls="cartPanel" title="Giỏ hàng">
              <span class="me-1" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M0 1.5A.5.5 0 0 1 .5 1h1a.5.5 0 0 1 .485.379L2.89 6H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 15H4a.5.5 0 0 1-.491-.408L1.61 2H.5a.5.5 0 0 1-.5-.5M3.14 6l1.25 7H12.6l1.312-7z"/>
                </svg>
              </span>
              <span>Giỏ</span>
              <span class="badge text-bg-danger" id="cartCount">0</span>
            </button>
            <div id="authBox"></div>
          </div>
        </div>
      </div>
    </nav>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartPanel" aria-labelledby="cartPanelLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="cartPanelLabel">Giỏ hàng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body d-flex flex-column">
        <div id="cartItems" class="list-group mb-3 small"></div>
        <div class="mt-auto border-top pt-3">
          <div class="d-flex justify-content-between mb-2"><span>Tổng</span><strong id="cartTotal">0 đ</strong></div>
          <div class="d-flex gap-2">
            <button id="clearCart" class="btn btn-outline-secondary w-50" type="button">Xóa giỏ</button>
            <a href="checkout.html" class="btn btn-primary w-50 text-center text-decoration-none">Thanh toán</a>
          </div>
        </div>
      </div>
    </div>

    <main class="container py-4">
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header"><h5 class="mb-0">Thông tin thanh toán</h5></div>
            <div class="card-body">
              <form id="checkoutForm">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Họ tên</label>
                    <input id="fullName" class="form-control" placeholder="Nguyen Van A" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Số điện thoại</label>
                    <input id="phone" class="form-control" placeholder="0912345678" required>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Địa chỉ</label>
                    <input id="address" class="form-control" placeholder="Số nhà, đường, quận/huyện, tỉnh/thành" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Phương thức thanh toán</label>
                    <select id="paymentMethod" class="form-select">
                      <option value="COD">Thanh toán khi nhận hàng (COD)</option>
                      <option value="ONLINE">Thanh toán online</option>
                    </select>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                  <button class="btn btn-primary" type="submit">Đặt hàng</button>
                  <a href="index.html" class="btn btn-outline-secondary">Tiếp tục mua</a>
                </div>
                <div id="msg" class="small mt-2"></div>
              </form>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header"><h6 class="mb-0">Đơn hàng của bạn</h6></div>
            <div class="card-body">
              <div id="orderItems" class="small"></div>
              <div class="d-flex justify-content-between border-top pt-2 mt-2">
                <strong>Tổng</strong>
                <strong id="orderTotal">0 đ</strong>
              </div>
              <div id="qrSection" class="mt-3" style="display:none;">
                <div class="small text-muted mb-2">Quét mã để thanh toán</div>
                <div class="text-center mb-2">
                  <img id="qrImage" src="" alt="VietQR" class="img-fluid border rounded" style="max-height:240px;object-fit:contain">
                </div>
                <div class="small">
                  <div class="d-flex justify-content-between"><span>Ngân hàng</span><strong id="bankCodeText"></strong></div>
                  <div class="d-flex justify-content-between"><span>Số tài khoản</span><strong id="accountNoText"></strong></div>
                  <div class="d-flex justify-content-between"><span>Tên tài khoản</span><strong id="accountNameText"></strong></div>
                  <div class="d-flex justify-content-between"><span>Nội dung</span><strong id="addInfoText"></strong></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = 'http://localhost:3000/api';
      const TOKEN_KEY = 'wm_token';
      const CART_KEY = 'wm_cart_items';
      const BANK_CODE = 'BIDV';
      const ACCOUNT_NO = '2153430151';
      const ACCOUNT_NAME = 'TRAN NGOC VIEN';
      function getToken(){ try { return localStorage.getItem(TOKEN_KEY) || ''; } catch { return ''; } }
      function loadCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; } }
      function saveCart(items){ localStorage.setItem(CART_KEY, JSON.stringify(items)); }
      function currency(v){ try { return Number(v).toLocaleString('vi-VN') + ' đ'; } catch { return v; } }
      function calcTotal(items){ return items.reduce((s, it) => s + (Number(it.price)||0) * (Number(it.qty)||1), 0); }
      function resolveImageUrl(url){ if(!url) return url; if(/^https?:\/\//i.test(url)) return url; if(url.startsWith('/static/')) return url; if(url.startsWith('public/')) return '/static/' + url.substring('public/'.length); return '/static/' + url.replace(/^\/+/, ''); }
      function buildOrderCode(){ const now = new Date(); return 'ORD' + now.getFullYear() + (now.getMonth()+1) + now.getDate() + '-' + Math.random().toString(36).slice(2,7).toUpperCase(); }
      // function buildVietQRUrl(amount, addInfo){ const safeInfo = encodeURIComponent(addInfo||'Thanh toan don hang'); return `https://img.vietqr.io/image/${BANK_CODE}-${ACCOUNT_NO}.png?amount=${Math.round(amount)}&addInfo=${safeInfo}&accountName=${encodeURIComponent(ACCOUNT_NAME)}`; }
      function buildVietQRUrl(amount, addInfo) {
  const safeInfo = encodeURIComponent(addInfo || 'Thanh toan don hang');
  return `https://img.vietqr.io/image/${BANK_CODE}-${ACCOUNT_NO}-compact.png?amount=${Math.round(amount)}&addInfo=${safeInfo}&accountName=${encodeURIComponent(ACCOUNT_NAME)}`;
}

      function renderSummary(){
        const items = loadCart();
        const $list = $('#orderItems');
        $list.empty();
        if(!items.length){ 
          $list.append('<div class="text-muted">Giỏ hàng trống</div>'); 
          $('#orderTotal').text(currency(0));
          $('#qrSection').hide();
          return;
        }
        items.forEach((it, idx) => {
          const href = `product_detail.html?id=${it.id}`;
          const img = it.image ? `<a href="${href}" class="me-2 flex-shrink-0 d-inline-flex align-items-center justify-content-center bg-light rounded" style="width:38px;height:38px;overflow:hidden"><img src="${resolveImageUrl(it.image)}" alt="${it.name||'image'}" style="max-width:100%;max-height:100%;object-fit:contain"></a>` : '';
          const qty = Number(it.qty) || 1;
          const price = Number(it.price) || 0;
          $list.append(`<div class="d-flex align-items-center justify-content-between py-2 border-bottom" data-index="${idx}">
            <div class="d-flex align-items-center flex-grow-1">
              ${img}
              <div class="flex-grow-1 me-2">
                <a href="${href}" class="text-decoration-none d-block">${it.name}</a>
                <div class="d-flex align-items-center gap-2 mt-1">
                  <button class="btn btn-sm btn-outline-secondary order-qty-dec" data-index="${idx}" type="button" style="width:28px;height:28px;padding:0;line-height:1;">-</button>
                  <span class="order-qty-value" data-index="${idx}" style="min-width:30px;text-align:center;font-weight:500;">${qty}</span>
                  <button class="btn btn-sm btn-outline-secondary order-qty-inc" data-index="${idx}" type="button" style="width:28px;height:28px;padding:0;line-height:1;">+</button>
                  <button class="btn btn-sm btn-outline-danger order-qty-del ms-2" data-index="${idx}" type="button" title="Xóa">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                      <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            <div class="text-end">
              <div class="fw-semibold">${currency(price * qty)}</div>
              <div class="small text-muted">${currency(price)}/sản phẩm</div>
            </div>
          </div>`);
        });
        const total = calcTotal(items);
        $('#orderTotal').text(currency(total));
        const pm = $('#paymentMethod').val();
        if(pm === 'ONLINE'){
          const orderCode = buildOrderCode();
          const qrUrl = buildVietQRUrl(total, orderCode);
          $('#qrImage').attr('src', qrUrl);
          $('#bankCodeText').text(BANK_CODE);
          $('#accountNoText').text(ACCOUNT_NO);
          $('#accountNameText').text(ACCOUNT_NAME);
          $('#addInfoText').text(orderCode);
          $('#qrSection').show();
        } else {
          $('#qrSection').hide();
        }
      }

      async function renderAuth(){
        const token = getToken();
        const box = document.getElementById('authBox');
        if(!box) return;
        if(token){
          let displayName = 'Tài khoản';
          try {
            const me = await $.ajax({ url: API_BASE + '/auth/me', headers: { Authorization: 'Bearer ' + token } });
            if (me && (me.name || me.email)) displayName = me.name || me.email;
          } catch {}
          box.innerHTML = `<div class="dropdown">\
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">${displayName}</button>\
            <ul class="dropdown-menu dropdown-menu-end">\
              <li><a class="dropdown-item" href="favorites.html"><i class="bi bi-heart me-2"></i>Sản phẩm yêu thích</a></li>\
              <li><a class="dropdown-item" href="orders.html"><i class="bi bi-bag-check me-2"></i>Đơn hàng của tôi</a></li>\
              <li><hr class="dropdown-divider"></li>\
              <li><a class="dropdown-item" href="change_password.html">Đổi mật khẩu</a></li>\
              <li><a class="dropdown-item" href="#" id="btnLogout">Đăng xuất</a></li>\
            </ul>\
          </div>`;
        } else {
          box.innerHTML = '<a class="btn btn-outline-primary" href="login.html">Đăng nhập</a>\
            <a class="btn btn-primary" href="register.html">Đăng ký</a>';
        }
      }
      function bindLogout(){
        $(document).off('click', '#btnLogout').on('click', '#btnLogout', function(e){
          e.preventDefault();
          const t = getToken();
          $.ajax({ url: API_BASE + '/auth/logout', method: 'POST', headers: t ? { Authorization: 'Bearer ' + t } : {} })
            .always(function(){ localStorage.removeItem(TOKEN_KEY); renderAuth(); window.location.href = 'index.html'; });
        });
      }

      function updateCartUI(){
        const items = loadCart();
        const $list = $('#cartItems');
        if($list.length) {
          $list.empty();
          if(!items.length){
            $list.append('<div class="text-muted text-center py-3">Giỏ hàng trống</div>');
          } else {
            items.forEach((it, idx) => {
              const detailHref = `product_detail.html?id=${it.id}`;
              const imgSrc = it.image ? resolveImageUrl(it.image) : '';
              const imgHtml = imgSrc ? `<a href="${detailHref}" class="me-2 flex-shrink-0 d-flex align-items-center justify-content-center bg-light rounded" style="width:48px;height:48px;overflow:hidden"><img src="${imgSrc}" alt="${it.name||'image'}" style="max-width:100%;max-height:100%;object-fit:contain"></a>` : '';
              const row = `
                <div class="list-group-item d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center flex-grow-1 me-2">
                    ${imgHtml}
                    <div class="flex-grow-1">
                      <div class="fw-semibold"><a href="${detailHref}" class="text-decoration-none text-dark">${it.name||'Sản phẩm'}</a></div>
                      <div class="text-muted">${currency(it.price)} × ${it.qty||1}</div>
                    </div>
                  </div>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary btn-dec" data-index="${idx}">-</button>
                    <button class="btn btn-outline-secondary btn-inc" data-index="${idx}">+</button>
                    <button class="btn btn-outline-danger btn-del" data-index="${idx}">x</button>
                  </div>
                </div>`;
              $list.append(row);
            });
          }
          $('#cartTotal').text(currency(calcTotal(items)));
          $('#cartCount').text(items.reduce((s,it)=>s+(Number(it.qty)||1),0));
        }
      }

      function addToCart(item){
        const items = loadCart();
        const idx = items.findIndex(it => it.id === item.id && it.price === item.price);
        if(idx > -1){ items[idx].qty = (Number(items[idx].qty)||1) + (Number(item.qty)||1); }
        else { items.push({ ...item, qty: Number(item.qty)||1 }); }
        saveCart(items);
        updateCartUI();
      }

      function prefillUser(){ const token = getToken(); if(!token) return; $.ajax({ url: API_BASE + '/auth/me', headers: { Authorization: 'Bearer ' + token } })
        .then(me => { if(me){ if(me.name) $('#fullName').val(me.name); if(me.phone) $('#phone').val(me.phone); if(me.address) $('#address').val(me.address); } })
        .catch(()=>{});
      }

      $('#checkoutForm').on('submit', function(e){
        e.preventDefault();
        const token = getToken();
        if(!token){ $('#msg').removeClass('text-success').addClass('text-danger').text('Bạn cần đăng nhập để đặt hàng.'); return; }
        const items = loadCart();
        if(!items.length){ $('#msg').removeClass('text-success').addClass('text-danger').text('Giỏ hàng trống.'); return; }
        const normalized = items.map(it => ({ product_id: it.id, quantity: Number(it.qty)||1, price: Number(it.price)||0 }));
        const payload = { items: normalized, payment_method: $('#paymentMethod').val() };
        $.ajax({ url: API_BASE + '/orders', method: 'POST', contentType: 'application/json', data: JSON.stringify(payload), headers: { Authorization: 'Bearer ' + token } })
          .then(order => { $('#msg').removeClass('text-danger').addClass('text-success').text('Đặt hàng thành công!'); saveCart([]); setTimeout(() => { window.location.href = 'index.html'; }, 1200); })
          .catch(err => { const message = (err && err.responseJSON && err.responseJSON.message) || 'Đặt hàng thất bại'; $('#msg').removeClass('text-success').addClass('text-danger').text(message); });
      });

      $(function(){ 
        renderAuth(); 
        bindLogout(); 
        renderSummary(); 
        prefillUser(); 
        updateCartUI();
        $('#paymentMethod').on('change', renderSummary);
        
        // Order items quantity controls (trong phần đơn hàng)
        $('#orderItems').on('click', '.order-qty-inc', function(){
          const idx = Number($(this).data('index')); 
          const items = loadCart();
          if(items[idx]){ 
            items[idx].qty = (Number(items[idx].qty)||1) + 1; 
            saveCart(items); 
            updateCartUI(); 
            renderSummary(); 
          }
        });
        $('#orderItems').on('click', '.order-qty-dec', function(){
          const idx = Number($(this).data('index')); 
          const items = loadCart();
          if(items[idx]){ 
            const newQty = Math.max(1, (Number(items[idx].qty)||1) - 1);
            items[idx].qty = newQty; 
            saveCart(items); 
            updateCartUI(); 
            renderSummary(); 
          }
        });
        $('#orderItems').on('click', '.order-qty-del', function(){
          const idx = Number($(this).data('index')); 
          const items = loadCart();
          if(Number.isInteger(idx) && items[idx]){ 
            if(confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')){
              items.splice(idx,1); 
              saveCart(items); 
              updateCartUI(); 
              renderSummary(); 
            }
          }
        });
        
        // Cart item controls (trong cart panel)
        $('#cartItems').on('click', '.btn-inc', function(){
          const idx = Number($(this).data('index')); 
          const items = loadCart();
          if(items[idx]){ items[idx].qty = (Number(items[idx].qty)||1) + 1; saveCart(items); updateCartUI(); renderSummary(); }
        });
        $('#cartItems').on('click', '.btn-dec', function(){
          const idx = Number($(this).data('index')); 
          const items = loadCart();
          if(items[idx]){ items[idx].qty = Math.max(1, (Number(items[idx].qty)||1) - 1); saveCart(items); updateCartUI(); renderSummary(); }
        });
        $('#cartItems').on('click', '.btn-del', function(){
          const idx = Number($(this).data('index')); 
          const items = loadCart();
          if(Number.isInteger(idx)){ items.splice(idx,1); saveCart(items); updateCartUI(); renderSummary(); }
        });
        $('#clearCart').on('click', function(){ 
          if(confirm('Bạn có chắc muốn xóa tất cả sản phẩm khỏi giỏ hàng?')){
            saveCart([]); 
            updateCartUI(); 
            renderSummary(); 
          }
        });
      });
    </script>
  </body>



