<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Đơn hàng của tôi - Web Mobile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      :root { --primary: #0d6efd; }
      body { background-color: #f8fafc; }
      .brand-text { color: #1d4ed8; }
      .product-card:hover { box-shadow: 0 6px 24px rgba(0,0,0,0.08); transform: translateY(-2px); }
      .product-card { transition: .2s ease; }
      .btn-cart { position: relative; }
      .btn-cart .badge { position: absolute; top: -6px; right: -6px; }
      .navbar { position: relative; }
      .navbar * { pointer-events: auto !important; }
      .order-card { border-left: 4px solid var(--primary); }
      .status-badge { font-size: 0.85rem; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top" style="z-index: 1030;">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <span class="rounded-circle bg-primary d-inline-block" style="width:28px;height:28px"></span>
          <span class="ms-2 fw-semibold brand-text">Web Mobile</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbars" aria-controls="navbars" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbars">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Trang chủ</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html#promo">Khuyến mãi</a></li>
                <li><a class="dropdown-item" href="index.html#new">Mới về</a></li>
                <li><a class="dropdown-item" href="index.html#top">Bán chạy</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Điện thoại</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html">Iphone</a></li>
                <li><a class="dropdown-item" href="index.html">Samsung</a></li>
                <li><a class="dropdown-item" href="index.html">Oppo</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Laptop</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html">Asus</a></li>
                <li><a class="dropdown-item" href="index.html">Dell</a></li>
                <li><a class="dropdown-item" href="index.html">Lenovo</a></li>
                <li><a class="dropdown-item" href="index.html">Macbook</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Phụ kiện</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html">Tai nghe</a></li>
                <li><a class="dropdown-item" href="index.html">Sạc</a></li>
                <li><a class="dropdown-item" href="index.html">Ốp lưng</a></li>
              </ul>
            </li>
          </ul>
          <div class="d-flex align-items-center gap-2">
            <form class="d-flex" role="search" onsubmit="window.location.href='index.html'; return false;">
              <input id="searchInput" class="form-control me-2" type="search" placeholder="Tìm kiếm..." aria-label="Search">
              <button class="btn btn-primary" type="button" onclick="window.location.href='index.html'">Tìm</button>
            </form>
            <button class="btn btn-outline-secondary btn-cart" type="button" data-bs-toggle="offcanvas" data-bs-target="#cartPanel" aria-controls="cartPanel" title="Giỏ hàng">
              <span class="me-1" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M0 1.5A.5.5 0 0 1 .5 1h1a.5.5 0 0 1 .485.379L2.89 6H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 15H4a.5.5 0 0 1-.491-.408L1.61 2H.5a.5.5 0 0 1-.5-.5M3.14 6l1.25 7H12.6l1.312-7z"/>
                </svg>
              </span>
              <span>Giỏ</span>
              <span class="badge text-bg-danger" id="cartCount">0</span>
            </button>
            <div id="authBox"></div>
          </div>
        </div>
      </div>
    </nav>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartPanel" aria-labelledby="cartPanelLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="cartPanelLabel">Giỏ hàng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body d-flex flex-column">
        <div id="cartItems" class="list-group mb-3 small"></div>
        <div class="mt-auto border-top pt-3">
          <div class="d-flex justify-content-between mb-2"><span>Tổng</span><strong id="cartTotal">0 đ</strong></div>
          <div class="d-flex gap-2">
            <button id="clearCart" class="btn btn-outline-secondary w-50" type="button">Xóa giỏ</button>
            <a href="checkout.html" class="btn btn-primary w-50 text-center text-decoration-none">Thanh toán</a>
          </div>
        </div>
      </div>
    </div>

    <main class="container py-4">
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
          <li class="breadcrumb-item active" aria-current="page">Đơn hàng của tôi</li>
        </ol>
      </nav>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="bi bi-bag-check me-2"></i>Đơn hàng của tôi</h2>
        <div id="ordersCount" class="badge bg-primary fs-6">0 đơn hàng</div>
      </div>

      <div id="ordersList">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
          <div class="mt-2">Đang tải đơn hàng...</div>
        </div>
      </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = 'http://localhost:3000/api';
      const TOKEN_KEY = 'wm_token';
      const CART_KEY = 'wm_cart_items';

      function getToken(){ try { return localStorage.getItem(TOKEN_KEY) || ''; } catch { return ''; } }
      function loadCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; } }
      function saveCart(items){ localStorage.setItem(CART_KEY, JSON.stringify(items)); }
      function calcTotal(items){ return items.reduce((s, it) => s + (Number(it.price)||0) * (Number(it.qty)||1), 0); }
      function currency(v){ try { return Number(v).toLocaleString('vi-VN') + ' đ'; } catch { return v; } }
      function resolveImageUrl(url){ if(!url) return url; if(/^https?:\/\//i.test(url)) return url; if(url.startsWith('/static/')) return url; if(url.startsWith('public/')) return '/static/' + url.substring('public/'.length); return '/static/' + url.replace(/^\/+/, ''); }
      function formatDate(dateStr){
        if(!dateStr) return 'N/A';
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString('vi-VN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        } catch { return dateStr; }
      }
      function getStatusBadge(status){
        const statusMap = {
          'pending': { text: 'Chờ xử lý', class: 'bg-warning' },
          'shipped': { text: 'Đã giao hàng', class: 'bg-primary' },
          'done': { text: 'Hoàn thành', class: 'bg-success' },
          'cancel': { text: 'Đã hủy', class: 'bg-danger' }
        };
        const s = statusMap[status] || { text: status || 'N/A', class: 'bg-secondary' };
        return `<span class="badge ${s.class} status-badge">${s.text}</span>`;
      }

      function updateCartUI(){
        const items = loadCart();
        const $list = $('#cartItems');
        if($list.length) {
          $list.empty();
          if(!items.length){
            $list.append('<div class="text-muted text-center py-3">Giỏ hàng trống</div>');
          } else {
            items.forEach((it, idx) => {
              const detailHref = `product_detail.html?id=${it.id}`;
              const imgSrc = it.image ? resolveImageUrl(it.image) : '';
              const imgHtml = imgSrc ? `<a href="${detailHref}" class="me-2 flex-shrink-0 d-flex align-items-center justify-content-center bg-light rounded" style="width:48px;height:48px;overflow:hidden"><img src="${imgSrc}" alt="${it.name||'image'}" style="max-width:100%;max-height:100%;object-fit:contain"></a>` : '';
              const row = `
                <div class="list-group-item d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center flex-grow-1 me-2">
                    ${imgHtml}
                    <div class="flex-grow-1">
                      <div class="fw-semibold"><a href="${detailHref}" class="text-decoration-none text-dark">${it.name||'Sản phẩm'}</a></div>
                      <div class="text-muted">${currency(it.price)} × ${it.qty||1}</div>
                    </div>
                  </div>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary btn-dec" data-index="${idx}">-</button>
                    <button class="btn btn-outline-secondary btn-inc" data-index="${idx}">+</button>
                    <button class="btn btn-outline-danger btn-del" data-index="${idx}">x</button>
                  </div>
                </div>`;
              $list.append(row);
            });
          }
          $('#cartTotal').text(currency(calcTotal(items)));
          $('#cartCount').text(items.reduce((s,it)=>s+(Number(it.qty)||1),0));
        }
      }

      async function renderAuth(){
        const token = getToken();
        const box = document.getElementById('authBox');
        if(!box) return;
        if(token){
          let displayName = 'Tài khoản';
          let userId = null;
          try {
            const me = await $.ajax({ url: API_BASE + '/auth/me', headers: { Authorization: 'Bearer ' + token } });
            if (me && (me.name || me.email)) displayName = me.name || me.email;
            if (me && me.user_id) userId = me.user_id;
          } catch {}
          box.innerHTML = `<div class="dropdown">\
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">${displayName}</button>\
            <ul class="dropdown-menu dropdown-menu-end">\
              <li><a class="dropdown-item" href="favorites.html"><i class="bi bi-heart me-2"></i>Sản phẩm yêu thích</a></li>\
              <li><a class="dropdown-item" href="orders.html"><i class="bi bi-bag-check me-2"></i>Đơn hàng của tôi</a></li>\
              <li><hr class="dropdown-divider"></li>\
              <li><a class="dropdown-item" href="change_password.html">Đổi mật khẩu</a></li>\
              <li><a class="dropdown-item" href="#" id="btnLogout">Đăng xuất</a></li>\
            </ul>\
          </div>`;
        } else {
          box.innerHTML = '<a class="btn btn-outline-primary" href="login.html">Đăng nhập</a>\
            <a class="btn btn-primary" href="register.html">Đăng ký</a>';
        }
      }
      function bindLogout(){
        $(document).off('click', '#btnLogout').on('click', '#btnLogout', function(e){
          e.preventDefault();
          const t = getToken();
          $.ajax({ url: API_BASE + '/auth/logout', method: 'POST', headers: t ? { Authorization: 'Bearer ' + t } : {} })
            .always(function(){ localStorage.removeItem(TOKEN_KEY); renderAuth(); window.location.href = 'index.html'; });
        });
      }

      async function loadOrders(){
        const token = getToken();
        if(!token){
          $('#ordersList').html('<div class="alert alert-warning text-center">Vui lòng <a href="login.html">đăng nhập</a> để xem đơn hàng</div>');
          return;
        }

        try {
          const me = await $.ajax({ 
            url: API_BASE + '/auth/me', 
            headers: { Authorization: 'Bearer ' + token } 
          }).fail(function(xhr, status, error) {
            console.error('Error getting user info:', status, error, xhr.responseText);
            throw new Error('Không thể lấy thông tin người dùng: ' + (xhr.responseJSON?.message || error));
          });
          
          if(!me || !me.user_id){
            $('#ordersList').html('<div class="alert alert-danger text-center">Không tìm thấy thông tin người dùng</div>');
            return;
          }

          console.log('Loading orders for user:', me.user_id);
          
          const orders = await $.ajax({ 
            url: API_BASE + '/orders/user/' + me.user_id, 
            headers: { Authorization: 'Bearer ' + token } 
          }).fail(function(xhr, status, error) {
            console.error('Error loading orders:', {
              status: xhr.status,
              statusText: xhr.statusText,
              responseText: xhr.responseText,
              responseJSON: xhr.responseJSON
            });
            throw xhr;
          });

          if(!orders || !orders.length){
            $('#ordersList').html('<div class="alert alert-info text-center"><i class="bi bi-inbox me-2"></i>Bạn chưa có đơn hàng nào</div>');
            $('#ordersCount').text('0 đơn hàng');
            return;
          }

          $('#ordersCount').text(`${orders.length} đơn hàng`);

          let html = '';
          orders.forEach(order => {
            const orderDetails = order.OrderDetails || [];
            // Tính tổng: ưu tiên total_price từ order, nếu không có thì tính từ orderDetails
            let total = 0;
            if (order.total_price !== undefined && order.total_price !== null) {
              total = Number(order.total_price) || 0;
            } else if (orderDetails.length > 0) {
              total = orderDetails.reduce((s, d) => {
                const price = Number(d.price) || 0;
                const qty = Number(d.quantity) || 1;
                return s + (price * qty);
              }, 0);
            }
            
            html += `
              <div class="card order-card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <strong>Mã đơn: #${order.order_id}</strong>
                    ${getStatusBadge(order.status)}
                  </div>
                  <div class="text-muted small">Mã đơn: #${order.order_id}</div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <strong>Phương thức thanh toán:</strong> ${order.payment_method === 'COD' ? 'Thanh toán khi nhận hàng' : 'Thanh toán online'}
                  </div>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Sản phẩm</th>
                          <th>Số lượng</th>
                          <th class="text-end">Giá</th>
                          <th class="text-end">Thành tiền</th>
                        </tr>
                      </thead>
                      <tbody>`;
            
            orderDetails.forEach(detail => {
              const product = detail.Product || {};
              const imgSrc = resolveImageUrl(product.image_url || product.image);
              html += `
                        <tr>
                          <td>
                            <div class="d-flex align-items-center">
                              <img src="${imgSrc || 'https://via.placeholder.com/50'}" alt="${product.name || 'Sản phẩm'}" style="width:50px;height:50px;object-fit:contain;margin-right:10px">
                              <a href="product_detail.html?id=${product.product_id || product.id}" class="text-decoration-none">${product.name || 'Sản phẩm'}</a>
                            </div>
                          </td>
                          <td>${detail.quantity || 1}</td>
                          <td class="text-end">${currency(detail.price || 0)}</td>
                          <td class="text-end fw-semibold">${currency((detail.price || 0) * (detail.quantity || 1))}</td>
                        </tr>`;
            });
            
            html += `
                      </tbody>
                      <tfoot>
                        <tr>
                          <td colspan="3" class="text-end"><strong>Tổng cộng:</strong></td>
                          <td class="text-end"><strong class="text-primary fs-5">${currency(total)}</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>`;
          });

          $('#ordersList').html(html);

        } catch(err){
          console.error('Error loading orders:', err);
          let errorMsg = 'Lỗi khi tải đơn hàng.';
          
          // Kiểm tra các loại lỗi khác nhau
          if(err.status === 403){
            errorMsg = 'Bạn không có quyền xem đơn hàng này.';
          } else if(err.status === 401){
            errorMsg = 'Phiên đăng nhập đã hết hạn. Vui lòng <a href="login.html">đăng nhập lại</a>.';
          } else if(err.status === 404){
            errorMsg = 'Không tìm thấy đơn hàng.';
          } else if(err.status === 500){
            errorMsg = 'Lỗi server. Vui lòng thử lại sau.';
            if(err.responseJSON && err.responseJSON.error){
              errorMsg += '<br><small class="text-muted">Chi tiết: ' + err.responseJSON.error + '</small>';
            }
          } else if(err.responseJSON){
            if(err.responseJSON.error){
              errorMsg += '<br><small class="text-muted">' + err.responseJSON.error + '</small>';
            } else if(err.responseJSON.message){
              errorMsg += '<br><small class="text-muted">' + err.responseJSON.message + '</small>';
            }
          } else if(err.statusText){
            errorMsg += '<br><small class="text-muted">' + err.statusText + '</small>';
          } else if(err.message){
            errorMsg += '<br><small class="text-muted">' + err.message + '</small>';
          }
          
          $('#ordersList').html('<div class="alert alert-danger text-center">' + errorMsg + '</div>');
        }
      }

      $(function(){
        renderAuth();
        bindLogout();
        updateCartUI();
        loadOrders();

        $('#cartItems').on('click', '.btn-inc', function(){
          const idx = Number($(this).data('index')); 
          const items = loadCart();
          if(items[idx]){ items[idx].qty = (Number(items[idx].qty)||1) + 1; saveCart(items); updateCartUI(); }
        });
        $('#cartItems').on('click', '.btn-dec', function(){
          const idx = Number($(this).data('index')); 
          const items = loadCart();
          if(items[idx]){ items[idx].qty = Math.max(1, (Number(items[idx].qty)||1) - 1); saveCart(items); updateCartUI(); }
        });
        $('#cartItems').on('click', '.btn-del', function(){
          const idx = Number($(this).data('index')); 
          const items = loadCart();
          if(Number.isInteger(idx)){ items.splice(idx,1); saveCart(items); updateCartUI(); }
        });
        $('#clearCart').on('click', function(){ 
          if(confirm('Bạn có chắc muốn xóa tất cả sản phẩm khỏi giỏ hàng?')){
            saveCart([]); 
            updateCartUI(); 
          }
        });
      });
    </script>
  </body>
</html>

