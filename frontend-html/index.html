<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Web Mobile Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      :root { --primary: #0d6efd; }
      body { background-color: #f8fafc; }
      .brand-text { color: #1d4ed8; }
      .product-card:hover { box-shadow: 0 6px 24px rgba(0,0,0,0.08); transform: translateY(-2px); }
      .product-card { transition: .2s ease; }
      .btn-cart { position: relative; }
      .btn-cart .badge { position: absolute; top: -6px; right: -6px; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top" style="z-index: 1030;">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <span class="rounded-circle bg-primary d-inline-block" style="width:28px;height:28px"></span>
          <span class="ms-2 fw-semibold brand-text">Web Mobile</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbars" aria-controls="navbars" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbars">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Trang chủ</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item nav-filter" href="#" data-section="promo">Khuyến mãi</a></li>
                <li><a class="dropdown-item nav-filter" href="#" data-section="new">Mới về</a></li>
                <li><a class="dropdown-item nav-filter" href="#" data-section="top">Bán chạy</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Điện thoại</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item nav-filter" href="#" data-brand="Apple">Iphone</a></li>
                <li><a class="dropdown-item nav-filter" href="#" data-brand="Samsung">Samsung</a></li>
                <li><a class="dropdown-item nav-filter" href="#" data-brand="Oppo">Oppo</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Laptop</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item nav-filter" href="#" data-brand="Asus">Asus</a></li>
                <li><a class="dropdown-item nav-filter" href="#" data-brand="Dell">Dell</a></li>
                <li><a class="dropdown-item nav-filter" href="#" data-brand="Lenovo">Lenovo</a></li>
                <li><a class="dropdown-item nav-filter" href="#" data-brand="Macbook">Macbook</a></li>

              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Phụ kiện</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item nav-filter" href="#" data-category="Tai nghe" data-category-id="3">Tai nghe</a></li>
                <li><a class="dropdown-item nav-filter" href="#" data-category="Sạc">Sạc</a></li>
                <li><a class="dropdown-item nav-filter" href="#" data-category="Ốp lưng">Ốp lưng</a></li>
              </ul>
            </li>
          </ul>
          <div class="d-flex align-items-center gap-2">
            <form class="d-flex" role="search" onsubmit="return false;">
              <input id="searchInput" class="form-control me-2" type="search" placeholder="Tìm kiếm..." aria-label="Search">
              <button class="btn btn-primary" type="button" id="searchBtn">Tìm</button>
            </form>
            <button class="btn btn-outline-secondary btn-cart" type="button" data-bs-toggle="offcanvas" data-bs-target="#cartPanel" aria-controls="cartPanel" title="Giỏ hàng">
              <span class="me-1" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M0 1.5A.5.5 0 0 1 .5 1h1a.5.5 0 0 1 .485.379L2.89 6H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 15H4a.5.5 0 0 1-.491-.408L1.61 2H.5a.5.5 0 0 1-.5-.5M3.14 6l1.25 7H12.6l1.312-7z"/>
                </svg>
              </span>
              <span>Giỏ</span>
              <span class="badge text-bg-danger" id="cartCount">0</span>
            </button>
            <div id="authBox"></div>
          </div>
        </div>
      </div>
    </nav>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartPanel" aria-labelledby="cartPanelLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="cartPanelLabel">Giỏ hàng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body d-flex flex-column">
        <div id="cartItems" class="list-group mb-3 small"></div>
        <div class="mt-auto border-top pt-3">
          <div class="d-flex justify-content-between mb-2"><span>Tổng</span><strong id="cartTotal">0 đ</strong></div>
          <div class="d-flex gap-2">
            <button id="clearCart" class="btn btn-outline-secondary w-50" type="button">Xóa giỏ</button>
            <button class="btn btn-primary w-50" type="button">Thanh toán</button>
          </div>
        </div>
      </div>
    </div>

    <main class="container py-4">
      <!-- Banner Carousel -->
      <div id="bannerCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
        <div class="carousel-inner" id="bannerInner">
          <div class="carousel-item active">
            <div class="bg-primary bg-gradient text-white rounded-3 d-flex align-items-center justify-content-center" style="height: 220px;">
              <div class="text-center">
                <div class="h4 fw-semibold">Khuyến mãi hấp dẫn</div>
                <div class="opacity-75">Sản phẩm di động giá tốt mỗi ngày</div>
              </div>
            </div>
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#bannerCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#bannerCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>

      <!-- Category Sections -->
      <section class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Điện thoại</h5>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="searchByPrice('Điện thoại', 0, 5000000)">Dưới 5M</button>
            <button class="btn btn-outline-primary" onclick="searchByPrice('Điện thoại', 5000000, 15000000)">5M-15M</button>
            <button class="btn btn-outline-primary" onclick="searchByPrice('Điện thoại', 15000000, 999999999)">Trên 15M</button>
          </div>
        </div>
        <div class="row g-3" id="gridPhones"></div>
      </section>

      <section class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Laptop</h5>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="searchByPrice('Laptop', 0, 15000000)">Dưới 15M</button>
            <button class="btn btn-outline-primary" onclick="searchByPrice('Laptop', 15000000, 30000000)">15M-30M</button>
            <button class="btn btn-outline-primary" onclick="searchByPrice('Laptop', 30000000, 999999999)">Trên 30M</button>
          </div>
        </div>
        <div class="row g-3" id="gridTablets"></div>
      </section>

      <section class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Phụ kiện</h5>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="searchByPrice('Phụ kiện', 0, 500000)">Dưới 500K</button>
            <button class="btn btn-outline-primary" onclick="searchByPrice('Phụ kiện', 500000, 2000000)">500K-2M</button>
            <button class="btn btn-outline-primary" onclick="searchByPrice('Phụ kiện', 2000000, 999999999)">Trên 2M</button>
          </div>
        </div>
        <div class="row g-3" id="gridAccessories"></div>
      </section>

      <!-- Search results (hidden by default) -->
      <section id="searchResultsSection" class="mb-2" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Kết quả tìm kiếm</h6>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="hideSearchResults">Ẩn</button>
        </div>
        <div class="row g-3" id="productGrid"></div>
      </section>
    </main>

    <footer class="bg-dark text-light py-5 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-3 mb-4">
            <h6 class="fw-bold mb-3">Tổng đài hỗ trợ miễn phí</h6>
            <div class="mb-2"><i class="bi bi-telephone me-2"></i><span class="fw-semibold">1900-xxxx</span></div>
            <div class="mb-2"><i class="bi bi-clock me-2"></i><span>8:00 - 22:00 (T2-CN)</span></div>
            <div class="mb-2"><i class="bi bi-envelope me-2"></i><span>support@webmobile.com</span></div>
            <div class="mb-2"><i class="bi bi-chat-dots me-2"></i><span>Chat trực tuyến</span></div>
          </div>
          <div class="col-md-3 mb-4">
            <h6 class="fw-bold mb-3">Thông tin và chính sách</h6>
            <ul class="list-unstyled">
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Giới thiệu</a></li>
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Chính sách bảo hành</a></li>
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Chính sách đổi trả</a></li>
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Chính sách vận chuyển</a></li>
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Chính sách bảo mật</a></li>
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Điều khoản sử dụng</a></li>
            </ul>
          </div>
          <div class="col-md-3 mb-4">
            <h6 class="fw-bold mb-3">Dịch vụ và thông tin khác</h6>
            <ul class="list-unstyled">
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Khuyến mãi</a></li>
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Tin tức công nghệ</a></li>
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Hướng dẫn mua hàng</a></li>
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Tuyển dụng</a></li>
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Liên hệ</a></li>
              <li class="mb-2"><a href="#" class="text-light text-decoration-none">Sitemap</a></li>
            </ul>
          </div>
          <div class="col-md-3 mb-4">
            <h6 class="fw-bold mb-3">Đăng ký</h6>
            <p class="small mb-3">Đăng ký nhận thông tin khuyến mãi và tin tức mới nhất</p>
            <div class="input-group mb-3">
              <input type="email" class="form-control" placeholder="Email của bạn" aria-label="Email">
              <button class="btn btn-primary" type="button"><i class="bi bi-arrow-right"></i></button>
            </div>
            <div class="mb-3">
              <h6 class="fw-bold mb-2">Theo dõi chúng tôi</h6>
              <div class="d-flex gap-2">
                <a href="#" class="text-light fs-5"><i class="bi bi-facebook"></i></a>
                <a href="#" class="text-light fs-5"><i class="bi bi-youtube"></i></a>
                <a href="#" class="text-light fs-5"><i class="bi bi-instagram"></i></a>
                <a href="#" class="text-light fs-5"><i class="bi bi-twitter"></i></a>
              </div>
            </div>
            <div class="small text-muted">© <span id="year"></span> Web Mobile. All rights reserved.</div>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = 'http://localhost:3000/api';
      const TOKEN_KEY = 'wm_token';
      document.getElementById('year').textContent = new Date().getFullYear();

      function currency(v){
        try { return Number(v).toLocaleString('vi-VN') + ' đ'; } catch { return v; }
      }

      function resolveImageUrl(url){
        if(!url) return url;
        if(/^https?:\/\//i.test(url)) return url;
        if(url.startsWith('/static/')) return url;
        if(url.startsWith('public/')) return '/static/' + url.substring('public/'.length);
        // default: treat as path under public/
        return '/static/' + url.replace(/^\/+/, '');
      }

      // Cart state helpers
      const CART_KEY = 'wm_cart_items';
      function loadCart(){
        try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; }
      }
      function saveCart(items){
        localStorage.setItem(CART_KEY, JSON.stringify(items));
      }
      function calcTotal(items){
        return items.reduce((s, it) => s + (Number(it.price)||0) * (Number(it.qty)||1), 0);
      }
      function updateCartUI(){
        const items = loadCart();
        const $list = $('#cartItems');
        $list.empty();
        if(!items.length){
          $list.append('<div class="text-muted text-center py-3">Giỏ hàng trống</div>');
        } else {
          items.forEach((it, idx) => {
            const detailHref = `product_detail.html?id=${it.id}`;
            const imgSrc = it.image ? resolveImageUrl(it.image) : '';
            const imgHtml = imgSrc ? `<a href="${detailHref}" class="me-2 flex-shrink-0 d-flex align-items-center justify-content-center bg-light rounded" style="width:48px;height:48px;overflow:hidden"><img src="${imgSrc}" alt="${it.name||'image'}" style="max-width:100%;max-height:100%;object-fit:contain"></a>` : '';
            const row = `
              <div class="list-group-item d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center flex-grow-1 me-2">
                  ${imgHtml}
                  <div class="flex-grow-1">
                    <div class="fw-semibold"><a href="${detailHref}" class="text-decoration-none text-dark">${it.name||'Sản phẩm'}</a></div>
                    <div class="text-muted">${currency(it.price)} × ${it.qty||1}</div>
                  </div>
                </div>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-secondary btn-dec" data-index="${idx}">-</button>
                  <button class="btn btn-outline-secondary btn-inc" data-index="${idx}">+</button>
                  <button class="btn btn-outline-danger btn-del" data-index="${idx}">x</button>
                </div>
              </div>`;
            $list.append(row);
          });
        }
        $('#cartTotal').text(currency(calcTotal(items)));
        $('#cartCount').text(items.reduce((s,it)=>s+(Number(it.qty)||1),0));
      }

      function addToCart(item){
        const items = loadCart();
        const idx = items.findIndex(it => it.id === item.id && it.price === item.price);
        if(idx > -1){ items[idx].qty = (Number(items[idx].qty)||1) + (Number(item.qty)||1); }
        else { items.push({ ...item, qty: Number(item.qty)||1 }); }
        saveCart(items);
        updateCartUI();
      }

      // Auth UI
      function getToken(){
        try { return localStorage.getItem(TOKEN_KEY) || ''; } catch { return ''; }
      }
      async function renderAuth(){
        const token = getToken();
        const box = document.getElementById('authBox');
        if(!box) return;
        if(token){
          let displayName = 'Tài khoản';
          try {
            const me = await $.ajax({ url: API_BASE + '/auth/me', headers: { Authorization: 'Bearer ' + token } });
            if (me && (me.name || me.email)) displayName = me.name || me.email;
          } catch {}
          box.innerHTML = `<div class="dropdown">\
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">${displayName}</button>\
            <ul class="dropdown-menu dropdown-menu-end">\
              <li><a class="dropdown-item" href="favorites.html"><i class="bi bi-heart me-2"></i>Sản phẩm yêu thích</a></li>\
              <li><a class="dropdown-item" href="orders.html"><i class="bi bi-bag-check me-2"></i>Đơn hàng của tôi</a></li>\
              <li><hr class="dropdown-divider"></li>\
              <li><a class="dropdown-item" href="change_password.html">Đổi mật khẩu</a></li>\
              <li><a class="dropdown-item" href="#" id="btnLogout">Đăng xuất</a></li>\
            </ul>\
          </div>`;
        } else {
          box.innerHTML = '<a class="btn btn-outline-primary" href="login.html">Đăng nhập</a>\
            <a class="btn btn-primary" href="register.html">Đăng ký</a>';
        }
      }
      function bindLogout(){
        $(document).off('click', '#btnLogout').on('click', '#btnLogout', function(e){
          e.preventDefault();
          const t = getToken();
          $.ajax({ url: API_BASE + '/auth/logout', method: 'POST', headers: t ? { Authorization: 'Bearer ' + t } : {} })
            .always(function(){ localStorage.removeItem(TOKEN_KEY); renderAuth(); window.location.href = 'index.html'; });
        });
      }

      function renderCard(p){
        // Handle both Sequelize format (product_id) and MongoDB format (_id)
        const pid = p.product_id || p._id || p.id || '';
        const detailHref = `product_detail.html?id=${pid}`;
        // Ensure price is a number
        const price = Number(p.price) || 0;
        return `
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card product-card h-100">
              <a href="${detailHref}" class="bg-light d-flex align-items-center justify-content-center" style="height:150px; text-decoration:none;">
                ${p.image_url ? `<img src="${resolveImageUrl(p.image_url)}" alt="${p.name||'image'}" style="max-height:100%;max-width:100%;object-fit:contain">` : '<span class="text-muted">Hình ảnh</span>'}
              </a>
              <div class="card-body d-flex flex-column">
                <div class="fw-semibold" style="min-height:3rem"><a href="${detailHref}" class="text-decoration-none text-dark">${p.name||''}</a></div>
                <div class="text-primary fw-bold mt-1">${currency(price)}</div>
                <div class="text-muted small mt-1">${p.brand||''} • ${p.ram||''} • ${p.storage||''}</div>
                <button class="btn btn-primary mt-auto add-to-cart"
                  data-id="${pid}"
                  data-name="${p.name||''}"
                  data-price="${price}"
                  data-image="${p.image_url||''}">Thêm vào giỏ</button>
              </div>
            </div>
          </div>`;
      }

      function renderProducts(list){
        const $grid = $('#productGrid');
        $grid.empty();
        if(!list || !Array.isArray(list) || !list.length){
          $grid.append('<div class="col-12 text-center text-muted py-4">Chưa có sản phẩm</div>');
          return;
        }
        list.forEach(p => $grid.append(renderCard(p)));
      }

      function renderInto(selector, list, limit = 20){
        const $grid = $(selector);
        $grid.empty();
        if(!list || !Array.isArray(list) || !list.length){
          $grid.append('<div class="col-12 text-center text-muted py-4">Chưa có sản phẩm</div>');
          return;
        }
        list.slice(0, limit).forEach(p => $grid.append(renderCard(p)));
      }

      function renderBanners(list){
        if(!list || !list.length) return;
        const $inner = $('#bannerInner');
        $inner.empty();
        list.forEach((b, idx) => {
          const active = idx === 0 ? 'active' : '';
          const item = `
            <div class="carousel-item ${active}">
              <a href="${b.link||'#'}">
                <img src="${b.image_url}" class="d-block w-100 rounded-3" style="max-height:220px;object-fit:cover" alt="${b.title||'banner'}">
              </a>
              ${b.title ? `<div class="carousel-caption d-none d-md-block"><h5>${b.title}</h5></div>` : ''}
            </div>`;
          $inner.append(item);
        });
      }

      function loadProducts(params){
        return $.get(API_BASE + '/products', params)
          .fail(function(xhr, status, error) {
            console.error('Error loading products:', status, error, xhr.responseText);
          });
      }

      function searchByPrice(category, minPrice, maxPrice){
        let targetGrid;
        let categoryParam = category; // Giữ nguyên category để gửi API
        
        switch(category){
          case 'Điện thoại': targetGrid = '#gridPhones'; break;
          case 'Laptop': 
            targetGrid = '#gridTablets';
            categoryParam = 'Tablet'; // Đổi 'Laptop' thành 'Tablet' để khớp với database
            break;
          case 'Phụ kiện': targetGrid = '#gridAccessories'; break;
          default: targetGrid = '#productGrid';
        }
        
        console.log('Searching products:', { category: categoryParam, min_price: minPrice, max_price: maxPrice });
        
        $.get(API_BASE + '/products', { category: categoryParam, min_price: minPrice, max_price: maxPrice })
          .then(products => {
            console.log(`Found ${products.length} products for ${categoryParam}`);
            renderInto(targetGrid, products, 10);
          })
          .catch(err => {
            console.error('Error searching products:', err);
            renderInto(targetGrid, [], 10);
          });
      }
      function loadBanners(){
        return $.get(API_BASE + '/banners').then(renderBanners).catch(() => {});
      }

      $(function(){
        loadBanners();
        renderAuth();
        bindLogout();
        // initial sections
        loadProducts({ category: 'Điện thoại' })
          .then(list => {
            console.log('Điện thoại products loaded:', list);
            renderInto('#gridPhones', list, 10);
          })
          .catch(err => {
            console.error('Error loading Điện thoại:', err);
            renderInto('#gridPhones', [], 10);
          });
        loadProducts({ category: 'Tablet' })
          .then(list => {
            console.log('Tablet products loaded:', list);
            renderInto('#gridTablets', list, 10);
          })
          .catch(err => {
            console.error('Error loading Tablet:', err);
            renderInto('#gridTablets', [], 10);
          });
        loadProducts({ category: 'Phụ kiện' })
          .then(list => {
            console.log('Phụ kiện products loaded:', list);
            renderInto('#gridAccessories', list, 10);
          })
          .catch(err => {
            console.error('Error loading Phụ kiện:', err);
            renderInto('#gridAccessories', [], 10);
          });

        // search by name/brand/description via backend 'search'
        $('#searchBtn').on('click', function(){
          const q = $('#searchInput').val().trim();
          const params = q ? { search: q } : {};
          $('#searchResultsSection').show();
          // Hide home sections and banner when showing search results
          $('#gridPhones').closest('section').hide();
          $('#gridTablets').closest('section').hide();
          $('#gridAccessories').closest('section').hide();
          $('#bannerCarousel').hide();
          $('#searchResultsSection h6').text('Kết quả tìm kiếm');
          loadProducts(params).then(renderProducts).catch(() => renderProducts([]));
        });
        // enter key triggers search
        $('#searchInput').on('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); $('#searchBtn').click(); } });

        // initial cart UI
        updateCartUI();

        // add to cart handler (event delegation across all sections)
        $(document).on('click', '.add-to-cart', function(){
          const $btn = $(this);
          addToCart({
            id: $btn.data('id') || String(Date.now()),
            name: $btn.data('name') || 'Sản phẩm',
            price: Number($btn.data('price')) || 0,
            image: $btn.data('image') || '',
            qty: 1
          });
        });

        // cart item controls
        $('#cartItems').on('click', '.btn-inc', function(){
          const idx = Number($(this).data('index')); const items = loadCart();
          if(items[idx]){ items[idx].qty = (Number(items[idx].qty)||1) + 1; saveCart(items); updateCartUI(); }
        });
        $('#cartItems').on('click', '.btn-dec', function(){
          const idx = Number($(this).data('index')); const items = loadCart();
          if(items[idx]){ items[idx].qty = Math.max(1, (Number(items[idx].qty)||1) - 1); saveCart(items); updateCartUI(); }
        });
        $('#cartItems').on('click', '.btn-del', function(){
          const idx = Number($(this).data('index')); const items = loadCart();
          if(Number.isInteger(idx)){ items.splice(idx,1); saveCart(items); updateCartUI(); }
        });
        $('#clearCart').on('click', function(){ saveCart([]); updateCartUI(); });

        // navbar filters
        $('.nav-filter').on('click', function(e){
          e.preventDefault();
          const brand = $(this).data('brand');
          const category = $(this).data('category');
          const categoryId = $(this).data('category-id');
          const section = $(this).data('section');
          
          // Hide home sections and banner
          $('#gridPhones').closest('section').hide();
          $('#gridTablets').closest('section').hide();
          $('#gridAccessories').closest('section').hide();
          $('#bannerCarousel').hide();
          $('#searchResultsSection').show();
          
          let title = 'Kết quả tìm kiếm';
          let promise;
          
          // Xử lý section (promo, new, top)
          if (section) {
            if (section === 'promo') {
              title = 'Sản phẩm khuyến mãi';
              promise = $.get(API_BASE + '/products/promotion').then(renderProducts).catch(() => renderProducts([]));
            } else if (section === 'new') {
              title = 'Sản phẩm mới về';
              promise = $.get(API_BASE + '/products/new').then(renderProducts).catch(() => renderProducts([]));
            } else if (section === 'top') {
              title = 'Sản phẩm bán chạy';
              promise = $.get(API_BASE + '/products/bestseller').then(renderProducts).catch(() => renderProducts([]));
            }
          }
          // Xử lý brand hoặc category
          else if (brand || category || categoryId) {
            const params = {};
            if (brand) params.brand = brand;
            if (categoryId) {
              params.category_id = categoryId;
            } else if (category) {
              params.category = category;
            }
            
            // Tạo tiêu đề phù hợp
            if (brand && category) {
              title = `${brand} - ${category}`;
            } else if (brand) {
              title = `Sản phẩm ${brand}`;
            } else if (category) {
              title = `Sản phẩm ${category}`;
            } else {
              title = 'Sản phẩm';
            }
            
            promise = loadProducts(params).then(renderProducts).catch(() => renderProducts([]));
          }
          
          if (promise) {
            $('#searchResultsSection h6').text(title);
          }
        });

        // hide search results and restore home sections and banner
        $('#hideSearchResults').on('click', function(){
          $('#searchResultsSection').hide();
          $('#gridPhones').closest('section').show();
          $('#gridTablets').closest('section').show();
          $('#gridAccessories').closest('section').show();
          $('#bannerCarousel').show();
          $('#searchResultsSection h6').text('Kết quả tìm kiếm');
        });

        // go checkout button in cart
        $('#cartPanel').on('click', '.btn.btn-primary.w-50', function(){ window.location.href = 'checkout.html'; });
      });
    </script>
  </body>
  </html>


