<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chi tiết sản phẩm - Web Mobile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      .product-image { max-height: 420px; object-fit: contain; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top" style="z-index: 1030;">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <span class="rounded-circle bg-primary d-inline-block" style="width:28px;height:28px"></span>
          <span class="ms-2 fw-semibold brand-text">Web Mobile</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbars" aria-controls="navbars" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbars">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Trang chủ</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html">Khuyến mãi</a></li>
                <li><a class="dropdown-item" href="index.html">Mới về</a></li>
                <li><a class="dropdown-item" href="index.html">Bán chạy</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Điện thoại</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html">Iphone</a></li>
                <li><a class="dropdown-item" href="index.html">Samsung</a></li>
                <li><a class="dropdown-item" href="index.html">Oppo</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Laptop</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html">Asus</a></li>
                <li><a class="dropdown-item" href="index.html">Dell</a></li>
                <li><a class="dropdown-item" href="index.html">Lenovo</a></li>
                <li><a class="dropdown-item" href="index.html">Macbook</a></li>
              </ul>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Phụ kiện</a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="index.html">Tai nghe</a></li>
                <li><a class="dropdown-item" href="index.html">Sạc</a></li>
                <li><a class="dropdown-item" href="index.html">Ốp lưng</a></li>
              </ul>
            </li>
          </ul>
          <div class="d-flex align-items-center gap-2">
            <form class="d-flex" role="search" onsubmit="window.location.href='index.html'; return false;">
              <input id="searchInput" class="form-control me-2" type="search" placeholder="Tìm kiếm..." aria-label="Search">
              <button class="btn btn-primary" type="button" onclick="window.location.href='index.html'">Tìm</button>
            </form>
            <button class="btn btn-outline-secondary btn-cart" type="button" data-bs-toggle="offcanvas" data-bs-target="#cartPanel" aria-controls="cartPanel" title="Giỏ hàng">
              <span class="me-1" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M0 1.5A.5.5 0 0 1 .5 1h1a.5.5 0 0 1 .485.379L2.89 6H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 15H4a.5.5 0 0 1-.491-.408L1.61 2H.5a.5.5 0 0 1-.5-.5M3.14 6l1.25 7H12.6l1.312-7z"/>
                </svg>
              </span>
              <span>Giỏ</span>
              <span class="badge text-bg-danger" id="cartCount">0</span>
            </button>
            <div id="authBox"></div>
          </div>
        </div>
      </div>
    </nav>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartPanel" aria-labelledby="cartPanelLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="cartPanelLabel">Giỏ hàng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body d-flex flex-column">
        <div id="cartItems" class="list-group mb-3 small"></div>
        <div class="mt-auto border-top pt-3">
          <div class="d-flex justify-content-between mb-2"><span>Tổng</span><strong id="cartTotal">0 đ</strong></div>
          <div class="d-flex gap-2">
            <button id="clearCart" class="btn btn-outline-secondary w-50" type="button">Xóa giỏ</button>
            <a href="checkout.html" class="btn btn-primary w-50 text-center text-decoration-none">Thanh toán</a>
          </div>
        </div>
      </div>
    </div>

    <main class="container py-4">
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
          <li class="breadcrumb-item"><a href="#" id="categoryLink">Danh mục</a></li>
          <li class="breadcrumb-item active" aria-current="page" id="productName">Sản phẩm</li>
        </ol>
      </nav>

      <div class="row" id="productDetail">
        <div class="col-12 text-center py-5">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
          <div class="mt-2">Đang tải thông tin sản phẩm...</div>
        </div>
      </div>
    </main>

    <footer class="bg-dark text-light py-5 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-3 mb-4"><h6 class="fw-bold mb-3">Tổng đài hỗ trợ miễn phí</h6><div class="mb-2"><i class="bi bi-telephone me-2"></i><span class="fw-semibold">1900-xxxx</span></div><div class="mb-2"><i class="bi bi-clock me-2"></i><span>8:00 - 22:00 (T2-CN)</span></div><div class="mb-2"><i class="bi bi-envelope me-2"></i><span>support@webmobile.com</span></div><div class="mb-2"><i class="bi bi-chat-dots me-2"></i><span>Chat trực tuyến</span></div></div>
          <div class="col-md-3 mb-4"><h6 class="fw-bold mb-3">Thông tin và chính sách</h6><ul class="list-unstyled"><li class="mb-2"><a href="#" class="text-light text-decoration-none">Giới thiệu</a></li><li class="mb-2"><a href="#" class="text-light text-decoration-none">Chính sách bảo hành</a></li><li class="mb-2"><a href="#" class="text-light text-decoration-none">Chính sách đổi trả</a></li><li class="mb-2"><a href="#" class="text-light text-decoration-none">Chính sách vận chuyển</a></li><li class="mb-2"><a href="#" class="text-light text-decoration-none">Chính sách bảo mật</a></li><li class="mb-2"><a href="#" class="text-light text-decoration-none">Điều khoản sử dụng</a></li></ul></div>
          <div class="col-md-3 mb-4"><h6 class="fw-bold mb-3">Dịch vụ và thông tin khác</h6><ul class="list-unstyled"><li class="mb-2"><a href="#" class="text-light text-decoration-none">Khuyến mãi</a></li><li class="mb-2"><a href="#" class="text-light text-decoration-none">Tin tức công nghệ</a></li><li class="mb-2"><a href="#" class="text-light text-decoration-none">Hướng dẫn mua hàng</a></li><li class="mb-2"><a href="#" class="text-light text-decoration-none">Tuyển dụng</a></li><li class="mb-2"><a href="#" class="text-light text-decoration-none">Liên hệ</a></li><li class="mb-2"><a href="#" class="text-light text-decoration-none">Sitemap</a></li></ul></div>
          <div class="col-md-3 mb-4"><h6 class="fw-bold mb-3">Đăng ký</h6><p class="small mb-3">Đăng ký nhận thông tin khuyến mãi và tin tức mới nhất</p><div class="input-group mb-3"><input type="email" class="form-control" placeholder="Email của bạn" aria-label="Email"><button class="btn btn-primary" type="button"><i class="bi bi-arrow-right"></i></button></div><div class="mb-3"><h6 class="fw-bold mb-2">Theo dõi chúng tôi</h6><div class="d-flex gap-2"><a href="#" class="text-light fs-5"><i class="bi bi-facebook"></i></a><a href="#" class="text-light fs-5"><i class="bi bi-youtube"></i></a><a href="#" class="text-light fs-5"><i class="bi bi-instagram"></i></a><a href="#" class="text-light fs-5"><i class="bi bi-twitter"></i></a></div></div></div>
        </div>
      </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = 'http://localhost:3000/api';
      const TOKEN_KEY = 'wm_token';
      function getToken(){ try { return localStorage.getItem(TOKEN_KEY) || ''; } catch { return ''; } }
      let currentProduct = null;

      const CART_KEY = 'wm_cart_items';
      function loadCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; } }
      function saveCart(items){ localStorage.setItem(CART_KEY, JSON.stringify(items)); }
      function calcTotal(items){ return items.reduce((s, it) => s + (Number(it.price)||0) * (Number(it.qty)||1), 0); }
      function currency(v){ try { return Number(v).toLocaleString('vi-VN') + ' đ'; } catch { return v; } }
      function resolveImageUrl(url){ if(!url) return url; if(/^https?:\/\//i.test(url)) return url; if(url.startsWith('/static/')) return url; if(url.startsWith('public/')) return '/static/' + url.substring('public/'.length); return '/static/' + url.replace(/^\/+/, ''); }
      function updateCartUI(){ const items = loadCart(); const $list = $('#cartItems'); $list.empty(); if(!items.length){ $list.append('<div class="text-muted text-center py-3">Giỏ hàng trống</div>'); } else { items.forEach((it, idx) => { const row = `\n            <div class="list-group-item d-flex align-items-center justify-content-between">\n              <div class="me-2 flex-grow-1">\n                <div class="fw-semibold">${it.name||'Sản phẩm'}</div>\n                <div class="text-muted">${currency(it.price)} × ${it.qty||1}</div>\n              </div>\n              <div class="btn-group btn-group-sm">\n                <button class="btn btn-outline-secondary btn-dec" data-index="${idx}">-</button>\n                <button class="btn btn-outline-secondary btn-inc" data-index="${idx}">+</button>\n                <button class="btn btn-outline-danger btn-del" data-index="${idx}">x</button>\n              </div>\n            </div>`; $list.append(row); }); } $('#cartTotal').text(currency(calcTotal(items))); $('#cartCount').text(items.reduce((s,it)=>s+(Number(it.qty)||1),0)); }

      function addToCart(item){ const items = loadCart(); const idx = items.findIndex(it => it.id === item.id); const currentQty = idx > -1 ? (Number(items[idx].qty) || 1) : 0; const newQty = currentQty + (Number(item.qty)||1); if(currentProduct && newQty > (currentProduct.stock||0)){ alert(`Chỉ còn ${currentProduct.stock} sản phẩm ${currentProduct.name} trong kho!`); return; } if(idx > -1){ items[idx].qty = newQty; } else { items.push({ ...item, qty: Number(item.qty)||1 }); } saveCart(items); updateCartUI(); }

      function loadProductDetail(){ const urlParams = new URLSearchParams(window.location.search); const productId = urlParams.get('id'); if(!productId){ showError('Không tìm thấy sản phẩm'); return; } $.get(API_BASE + '/products/' + productId).then(product => { renderProductDetail(product); loadReviews(product.product_id); initFavorite(product.product_id); }).catch(() => { showError('Không thể tải thông tin sản phẩm'); }); }

      function renderProductDetail(product){ currentProduct = product; const html = `
        <div class="col-md-6">
          <div class="bg-light rounded p-3 mb-3">
            <img src="${resolveImageUrl(product.image_url)}" alt="${product.name}" class="product-image w-100">
          </div>
        </div>
        <div class="col-md-6">
          <h2 class="fw-bold mb-2">${product.name}</h2>
          <div class="text-primary fw-bold fs-3 mb-3">${currency(product.price)}</div>
          <div class="mb-3 text-muted">Còn lại: ${product.stock||0} sản phẩm</div>
          <div class="mb-3">
            <div class="d-inline-flex align-items-center">
              <button class="btn btn-outline-secondary btn-sm" id="decreaseQty">-</button>
              <input type="number" class="form-control text-center mx-2" id="quantity" value="1" min="1" max="${product.stock||1}" style="width: 80px;">
              <button class="btn btn-outline-secondary btn-sm" id="increaseQty">+</button>
            </div>
          </div>
          <div class="d-grid gap-2 mb-4">
            <button class="btn btn-primary btn-lg" id="addToCartBtn"><i class="bi bi-cart-plus me-2"></i>Thêm vào giỏ hàng</button>
            <button class="btn btn-outline-primary" id="btnFavorite"><i class="bi bi-heart me-2" id="favIcon"></i><span id="favText">Thêm vào yêu thích</span></button>
          </div>
          <div class="card">
            <div class="card-header"><h6 class="mb-0">Thông số kỹ thuật</h6></div>
            <div class="card-body">
              <div class="d-flex justify-content-between border-bottom py-2"><span class="text-muted">Thương hiệu:</span><span>${product.brand||'N/A'}</span></div>
              <div class="d-flex justify-content-between border-bottom py-2"><span class="text-muted">RAM:</span><span>${product.ram||'N/A'}</span></div>
              <div class="d-flex justify-content-between border-bottom py-2"><span class="text-muted">Bộ nhớ:</span><span>${product.storage||'N/A'}</span></div>
              <div class="d-flex justify-content-between py-2"><span class="text-muted">Danh mục:</span><span>${product.category ? product.category.name : 'N/A'}</span></div>
            </div>
          </div>
        </div>
        <div class="col-12 mt-4">
          <div class="card">
            <div class="card-header"><h6 class="mb-0">Mô tả sản phẩm</h6></div>
            <div class="card-body"><p>${product.description || 'Chưa có mô tả chi tiết cho sản phẩm này.'}</p></div>
          </div>
        </div>
        <div class="col-12 mt-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center"><h6 class="mb-0">Đánh giá & Bình luận</h6></div>
            <div class="card-body">
              <div id="reviewsList" class="mb-3 small"></div>
              <form id="reviewForm" class="border-top pt-3">
                <div class="row g-2 align-items-center">
                  <div class="col-auto"><label class="col-form-label">Đánh giá:</label></div>
                  <div class="col-auto"><select id="rating" class="form-select"><option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select></div>
                  <div class="col"><input id="comment" class="form-control" placeholder="Chia sẻ cảm nhận của bạn..."></div>
                  <div class="col-auto"><button type="submit" class="btn btn-primary">Gửi</button></div>
                </div>
                <div id="reviewMsg" class="small mt-2"></div>
              </form>
            </div>
          </div>
        </div>`;
        $('#productDetail').html(html);

        $('#productName').text(product.name);
        if (product.category) { $('#categoryLink').text(product.category.name).attr('href', `index.html?category=${product.category.name}`); }

        $('#decreaseQty').on('click', function(){ const q = parseInt($('#quantity').val()); if(q > 1) $('#quantity').val(q-1); });
        $('#increaseQty').on('click', function(){ const q = parseInt($('#quantity').val()); const max = currentProduct.stock||1; if(q < max) $('#quantity').val(q+1); });
        $('#quantity').on('input', function(){ const q = parseInt($(this).val()); const max = currentProduct.stock||1; if(q < 1) $(this).val(1); else if(q > max) { $(this).val(max); alert(`Chỉ còn ${max} sản phẩm trong kho!`); } });

        $('#addToCartBtn').on('click', function(){ const qty = parseInt($('#quantity').val()); if(qty < 1) return; addToCart({ id: product.product_id, name: product.name, price: product.price, qty }); const $btn = $(this); const t = $btn.html(); $btn.html('<i class="bi bi-check me-2"></i>Đã thêm vào giỏ').removeClass('btn-primary').addClass('btn-success'); setTimeout(()=>{ $btn.html(t).removeClass('btn-success').addClass('btn-primary'); }, 1600); });

        $('#btnFavorite').on('click', function(){ const t = getToken(); if(!t){ alert('Vui lòng đăng nhập để thêm yêu thích'); return; } $.ajax({ url: API_BASE + '/auth/favorites/toggle', method: 'POST', contentType: 'application/json', data: JSON.stringify({ product_id: product.product_id }), headers: { Authorization: 'Bearer ' + t } }).then(res => { const favs = (res && res.favorites) || []; updateFavUI(favs.includes(product.product_id)); }); });

        $('#reviewForm').on('submit', function(e){ e.preventDefault(); const t = getToken(); if(!t){ $('#reviewMsg').removeClass('text-success').addClass('text-danger').text('Bạn cần đăng nhập để đánh giá.'); return; } const payload = { product_id: product.product_id, rating: Number($('#rating').val())||5, comment: $('#comment').val().trim() }; $.ajax({ url: API_BASE + '/reviews', method: 'POST', contentType: 'application/json', data: JSON.stringify(payload), headers: { Authorization: 'Bearer ' + t } }).then(() => { $('#reviewMsg').removeClass('text-danger').addClass('text-success').text('Đã gửi đánh giá.'); $('#comment').val(''); loadReviews(product.product_id); }).catch(() => { $('#reviewMsg').removeClass('text-success').addClass('text-danger').text('Gửi đánh giá thất bại.'); }); });
      }

      function updateFavUI(isFav){ const icon = document.getElementById('favIcon'); const text = document.getElementById('favText'); if(!icon || !text) return; if(isFav){ icon.classList.remove('bi-heart'); icon.classList.add('bi-heart-fill'); text.textContent = 'Đã yêu thích'; } else { icon.classList.remove('bi-heart-fill'); icon.classList.add('bi-heart'); text.textContent = 'Thêm vào yêu thích'; } }
      function initFavorite(productId){ const t = getToken(); if(!t){ updateFavUI(false); return; } $.ajax({ url: API_BASE + '/auth/favorites', headers: { Authorization: 'Bearer ' + t } }).then(res => { const favs = (res && res.favorites) || []; updateFavUI(favs.includes(Number(productId))); }).catch(() => updateFavUI(false)); }
      function renderReviews(list){ const box = $('#reviewsList'); box.empty(); if(!list || !list.length){ box.append('<div class="text-muted">Chưa có đánh giá nào.</div>'); return; } list.forEach(rv => { const row = `\n        <div class=\"border-bottom py-2\">\n          <div class=\"d-flex align-items-center justify-content-between\">\n            <strong>Người dùng</strong>\n            <span class=\"badge text-bg-primary\">${rv.rating}/5</span>\n          </div>\n          <div>${rv.comment || ''}</div>\n        </div>`; box.append(row); }); }
      function loadReviews(productId){ $.get(API_BASE + '/reviews/' + productId).then(list => renderReviews(list)).catch(() => renderReviews([])); }

      async function renderAuth(){
        const token = getToken();
        const box = document.getElementById('authBox');
        if(!box) return;
        if(token){
          let displayName = 'Tài khoản';
          try {
            const me = await $.ajax({ url: API_BASE + '/auth/me', headers: { Authorization: 'Bearer ' + token } });
            if (me && (me.name || me.email)) displayName = me.name || me.email;
          } catch {}
          box.innerHTML = `<div class="dropdown">\
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">${displayName}</button>\
            <ul class="dropdown-menu dropdown-menu-end">\
              <li><a class="dropdown-item" href="favorites.html"><i class="bi bi-heart me-2"></i>Sản phẩm yêu thích</a></li>\
              <li><a class="dropdown-item" href="orders.html"><i class="bi bi-bag-check me-2"></i>Đơn hàng của tôi</a></li>\
              <li><hr class="dropdown-divider"></li>\
              <li><a class="dropdown-item" href="change_password.html">Đổi mật khẩu</a></li>\
              <li><a class="dropdown-item" href="#" id="btnLogout">Đăng xuất</a></li>\
            </ul>\
          </div>`;
        } else {
          box.innerHTML = '<a class="btn btn-outline-primary" href="login.html">Đăng nhập</a>\
            <a class="btn btn-primary" href="register.html">Đăng ký</a>';
        }
      }
      function bindLogout(){
        $(document).off('click', '#btnLogout').on('click', '#btnLogout', function(e){
          e.preventDefault();
          const t = getToken();
          $.ajax({ url: API_BASE + '/auth/logout', method: 'POST', headers: t ? { Authorization: 'Bearer ' + t } : {} })
            .always(function(){ localStorage.removeItem(TOKEN_KEY); renderAuth(); window.location.href = 'index.html'; });
        });
      }

      $(function(){ 
        renderAuth(); 
        bindLogout(); 
        updateCartUI(); 
        $('#cartItems').on('click', '.btn-inc', function(){ const idx = Number($(this).data('index')); const items = loadCart(); if(items[idx]){ items[idx].qty = (Number(items[idx].qty)||1) + 1; saveCart(items); updateCartUI(); } }); 
        $('#cartItems').on('click', '.btn-dec', function(){ const idx = Number($(this).data('index')); const items = loadCart(); if(items[idx]){ items[idx].qty = Math.max(1, (Number(items[idx].qty)||1) - 1); saveCart(items); updateCartUI(); } }); 
        $('#cartItems').on('click', '.btn-del', function(){ const idx = Number($(this).data('index')); const items = loadCart(); if(Number.isInteger(idx)){ items.splice(idx,1); saveCart(items); updateCartUI(); } }); 
        $('#clearCart').on('click', function(){ saveCart([]); updateCartUI(); }); 
        $('#cartPanel').on('click', '.btn.btn-primary.w-50', function(){ window.location.href = 'checkout.html'; }); 
        loadProductDetail(); 
      });
    </script>
  </body>
  </html>


