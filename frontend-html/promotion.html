<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Khuyến mãi - Web Mobile</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #0d6efd;
      }
      body {
        background-color: #f8fafc;
      }
      .brand-text {
        color: #1d4ed8;
      }
      .product-card:hover {
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
      }
      .product-card {
        transition: 0.2s ease;
      }
      .btn-cart {
        position: relative;
      }
      .btn-cart .badge {
        position: absolute;
        top: -6px;
        right: -6px;
      }
      .badge-sale {
        background-color: #dc3545;
        color: white;
      }
      .price-old {
        text-decoration: line-through;
        color: #6c757d;
        font-size: 0.9em;
      }
      .price-sale {
        color: #dc3545;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <span
            class="rounded-circle bg-primary d-inline-block"
            style="width: 28px; height: 28px"
          ></span>
          <span class="ms-2 fw-semibold brand-text">Web Mobile</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbars"
          aria-controls="navbars"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbars">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Trang chủ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="promotion.html">Khuyến mãi</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="new.html">Mới về</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="bestseller.html">Bán chạy</a>
            </li>
          </ul>
          <div class="d-flex align-items-center gap-2">
            <button
              class="btn btn-outline-secondary btn-cart"
              type="button"
              data-bs-toggle="offcanvas"
              data-bs-target="#cartPanel"
              aria-controls="cartPanel"
              title="Giỏ hàng"
            >
              <span class="me-1" aria-hidden="true">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 16 16"
                  fill="currentColor"
                >
                  <path
                    d="M0 1.5A.5.5 0 0 1 .5 1h1a.5.5 0 0 1 .485.379L2.89 6H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 15H4a.5.5 0 0 1-.491-.408L1.61 2H.5a.5.5 0 0 1-.5-.5M3.14 6l1.25 7H12.6l1.312-7z"
                  />
                </svg>
              </span>
              <span>Giỏ</span>
              <span class="badge text-bg-danger" id="cartCount">0</span>
            </button>
            <div id="authBox"></div>
          </div>
        </div>
      </div>
    </nav>

    <div
      class="offcanvas offcanvas-end"
      tabindex="-1"
      id="cartPanel"
      aria-labelledby="cartPanelLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="cartPanelLabel">Giỏ hàng</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body d-flex flex-column">
        <div id="cartItems" class="list-group mb-3 small"></div>
        <div class="mt-auto border-top pt-3">
          <div class="d-flex justify-content-between mb-2">
            <span>Tổng</span><strong id="cartTotal">0 đ</strong>
          </div>
          <div class="d-flex gap-2">
            <button
              id="clearCart"
              class="btn btn-outline-secondary w-50"
              type="button"
            >
              Xóa giỏ
            </button>
            <button class="btn btn-primary w-50" type="button">
              Thanh toán
            </button>
          </div>
        </div>
      </div>
    </div>

    <main class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">Sản phẩm khuyến mãi</h4>
      </div>
      <div class="row g-3" id="productGrid">
        <div class="col-12 text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div class="mt-2">Đang tải sản phẩm...</div>
        </div>
      </div>
    </main>

    <footer class="bg-dark text-light py-5 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-3 mb-4">
            <h6 class="fw-bold mb-3">Tổng đài hỗ trợ miễn phí</h6>
            <div class="mb-2">
              <i class="bi bi-telephone me-2"></i
              ><span class="fw-semibold">1900-xxxx</span>
            </div>
            <div class="mb-2">
              <i class="bi bi-clock me-2"></i><span>8:00 - 22:00 (T2-CN)</span>
            </div>
            <div class="mb-2">
              <i class="bi bi-envelope me-2"></i
              ><span>support@webmobile.com</span>
            </div>
            <div class="mb-2">
              <i class="bi bi-chat-dots me-2"></i><span>Chat trực tuyến</span>
            </div>
          </div>
          <div class="col-md-3 mb-4">
            <h6 class="fw-bold mb-3">Thông tin và chính sách</h6>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none"
                  >Giới thiệu</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none"
                  >Chính sách bảo hành</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none"
                  >Chính sách đổi trả</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none"
                  >Chính sách vận chuyển</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none"
                  >Chính sách bảo mật</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none"
                  >Điều khoản sử dụng</a
                >
              </li>
            </ul>
          </div>
          <div class="col-md-3 mb-4">
            <h6 class="fw-bold mb-3">Dịch vụ và thông tin khác</h6>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none"
                  >Khuyến mãi</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none"
                  >Tin tức công nghệ</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none"
                  >Hướng dẫn mua hàng</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none"
                  >Tuyển dụng</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none">Liên hệ</a>
              </li>
              <li class="mb-2">
                <a href="#" class="text-light text-decoration-none">Sitemap</a>
              </li>
            </ul>
          </div>
          <div class="col-md-3 mb-4">
            <h6 class="fw-bold mb-3">Đăng ký</h6>
            <p class="small mb-3">
              Đăng ký nhận thông tin khuyến mãi và tin tức mới nhất
            </p>
            <div class="input-group mb-3">
              <input
                type="email"
                class="form-control"
                placeholder="Email của bạn"
                aria-label="Email"
              /><button class="btn btn-primary" type="button">
                <i class="bi bi-arrow-right"></i>
              </button>
            </div>
            <div class="mb-3">
              <h6 class="fw-bold mb-2">Theo dõi chúng tôi</h6>
              <div class="d-flex gap-2">
                <a href="#" class="text-light fs-5"
                  ><i class="bi bi-facebook"></i></a
                ><a href="#" class="text-light fs-5"
                  ><i class="bi bi-youtube"></i></a
                ><a href="#" class="text-light fs-5"
                  ><i class="bi bi-instagram"></i></a
                ><a href="#" class="text-light fs-5"
                  ><i class="bi bi-twitter"></i
                ></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = "http://localhost:3000/api";
      const TOKEN_KEY = "wm_token";
      document.getElementById("year").textContent = new Date().getFullYear();

      function currency(v) {
        try {
          return Number(v).toLocaleString("vi-VN") + " đ";
        } catch {
          return v;
        }
      }

      function resolveImageUrl(url) {
        if (!url) return url;
        if (/^https?:\/\//i.test(url)) return url;
        if (url.startsWith("/static/")) return url;
        if (url.startsWith("public/"))
          return "/static/" + url.substring("public/".length);
        return "/static/" + url.replace(/^\/+/, "");
      }

      const CART_KEY = "wm_cart_items";
      function loadCart() {
        try {
          return JSON.parse(localStorage.getItem(CART_KEY)) || [];
        } catch {
          return [];
        }
      }
      function saveCart(items) {
        localStorage.setItem(CART_KEY, JSON.stringify(items));
      }
      function calcTotal(items) {
        return items.reduce(
          (s, it) => s + (Number(it.price) || 0) * (Number(it.qty) || 1),
          0
        );
      }
      function updateCartUI() {
        const items = loadCart();
        const $list = $("#cartItems");
        $list.empty();
        if (!items.length) {
          $list.append(
            '<div class="text-muted text-center py-3">Giỏ hàng trống</div>'
          );
        } else {
          items.forEach((it, idx) => {
            const detailHref = `product_detail.html?id=${it.id}`;
            const imgSrc = it.image ? resolveImageUrl(it.image) : "";
            const imgHtml = imgSrc
              ? `<a href="${detailHref}" class="me-2 flex-shrink-0 d-flex align-items-center justify-content-center bg-light rounded" style="width:48px;height:48px;overflow:hidden"><img src="${imgSrc}" alt="${
                  it.name || "image"
                }" style="max-width:100%;max-height:100%;object-fit:contain"></a>`
              : "";
            const row = `
              <div class="list-group-item d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center flex-grow-1 me-2">
                  ${imgHtml}
                  <div class="flex-grow-1">
                    <div class="fw-semibold"><a href="${detailHref}" class="text-decoration-none text-dark">${
              it.name || "Sản phẩm"
            }</a></div>
                    <div class="text-muted">${currency(it.price)} × ${
              it.qty || 1
            }</div>
                  </div>
                </div>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-secondary btn-dec" data-index="${idx}">-</button>
                  <button class="btn btn-outline-secondary btn-inc" data-index="${idx}">+</button>
                  <button class="btn btn-outline-danger btn-del" data-index="${idx}">x</button>
                </div>
              </div>`;
            $list.append(row);
          });
        }
        $("#cartTotal").text(currency(calcTotal(items)));
        $("#cartCount").text(
          items.reduce((s, it) => s + (Number(it.qty) || 1), 0)
        );
      }

      function addToCart(item) {
        const items = loadCart();
        const idx = items.findIndex(
          (it) => it.id === item.id && it.price === item.price
        );
        if (idx > -1) {
          items[idx].qty =
            (Number(items[idx].qty) || 1) + (Number(item.qty) || 1);
        } else {
          items.push({ ...item, qty: Number(item.qty) || 1 });
        }
        saveCart(items);
        updateCartUI();
      }

      function getToken() {
        try {
          return localStorage.getItem(TOKEN_KEY) || "";
        } catch {
          return "";
        }
      }
      async function renderAuth() {
        const token = getToken();
        const box = document.getElementById("authBox");
        if (!box) return;
        if (token) {
          let displayName = "Tài khoản";
          try {
            const me = await $.ajax({
              url: API_BASE + "/auth/me",
              headers: { Authorization: "Bearer " + token },
            });
            if (me && (me.name || me.email)) displayName = me.name || me.email;
          } catch {}
          box.innerHTML = `<div class="dropdown">\
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">${displayName}</button>\
            <ul class="dropdown-menu dropdown-menu-end">\
              <li><a class="dropdown-item" href="change_password.html">Đổi mật khẩu</a></li>\
              <li><a class="dropdown-item" href="#" id="btnLogout">Đăng xuất</a></li>\
            </ul>\
          </div>`;
        } else {
          box.innerHTML =
            '<a class="btn btn-outline-primary" href="login.html">Đăng nhập</a>\
            <a class="btn btn-primary" href="register.html">Đăng ký</a>';
        }
      }
      function bindLogout() {
        $(document)
          .off("click", "#btnLogout")
          .on("click", "#btnLogout", function (e) {
            e.preventDefault();
            const t = getToken();
            $.ajax({
              url: API_BASE + "/auth/logout",
              method: "POST",
              headers: t ? { Authorization: "Bearer " + t } : {},
            }).always(function () {
              localStorage.removeItem(TOKEN_KEY);
              renderAuth();
              window.location.href = "index.html";
            });
          });
      }

      function renderCard(p) {
        const pid = p._id || p.id || p.product_id || "";
        const detailHref = `product_detail.html?id=${pid}`;
        const salePrice = p.sale_price || p.price;
        const originalPrice = p.price;
        const hasSale =
          p.sale_price && Number(p.sale_price) < Number(originalPrice);
        const discountPercent = hasSale
          ? Math.round((1 - Number(salePrice) / Number(originalPrice)) * 100)
          : 0;
        return `
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card product-card h-100 position-relative">
              ${
                hasSale
                  ? `<span class="badge badge-sale position-absolute top-0 start-0 m-2">-${discountPercent}%</span>`
                  : ""
              }
              <a href="${detailHref}" class="bg-light d-flex align-items-center justify-content-center" style="height:150px; text-decoration:none;">
                ${
                  p.image_url
                    ? `<img src="${resolveImageUrl(p.image_url)}" alt="${
                        p.name || "image"
                      }" style="max-height:100%;max-width:100%;object-fit:contain">`
                    : '<span class="text-muted">Hình ảnh</span>'
                }
              </a>
              <div class="card-body d-flex flex-column">
                <div class="fw-semibold" style="min-height:3rem"><a href="${detailHref}" class="text-decoration-none text-dark">${
          p.name || ""
        }</a></div>
                <div class="mt-1">
                  ${
                    hasSale
                      ? `<div class="price-old">${currency(
                          originalPrice
                        )}</div><div class="price-sale">${currency(
                          salePrice
                        )}</div>`
                      : `<div class="text-primary fw-bold">${currency(
                          originalPrice
                        )}</div>`
                  }
                </div>
                <div class="text-muted small mt-1">${p.brand || ""} • ${
          p.ram || ""
        } • ${p.storage || ""}</div>
                <button class="btn btn-primary mt-auto add-to-cart"
                  data-id="${pid}"
                  data-name="${p.name || ""}"
                  data-price="${salePrice || originalPrice || 0}"
                  data-image="${p.image_url || ""}">Thêm vào giỏ</button>
              </div>
            </div>
          </div>`;
      }

      function renderProducts(list) {
        const $grid = $("#productGrid");
        $grid.empty();
        if (!list || !list.length) {
          $grid.append(
            '<div class="col-12 text-center text-muted py-4">Chưa có sản phẩm khuyến mãi</div>'
          );
          return;
        }
        list.forEach((p) => $grid.append(renderCard(p)));
      }

      function loadPromotionProducts() {
        $.get(API_BASE + "/products/promotion", { limit: 50 })
          .then((products) => renderProducts(products))
          .catch(() => renderProducts([]));
      }

      $(function () {
        renderAuth();
        bindLogout();
        updateCartUI();
        loadPromotionProducts();

        $(document).on("click", ".add-to-cart", function () {
          const $btn = $(this);
          addToCart({
            id: $btn.data("id") || String(Date.now()),
            name: $btn.data("name") || "Sản phẩm",
            price: Number($btn.data("price")) || 0,
            image: $btn.data("image") || "",
            qty: 1,
          });
        });

        $("#cartItems").on("click", ".btn-inc", function () {
          const idx = Number($(this).data("index"));
          const items = loadCart();
          if (items[idx]) {
            items[idx].qty = (Number(items[idx].qty) || 1) + 1;
            saveCart(items);
            updateCartUI();
          }
        });
        $("#cartItems").on("click", ".btn-dec", function () {
          const idx = Number($(this).data("index"));
          const items = loadCart();
          if (items[idx]) {
            items[idx].qty = Math.max(1, (Number(items[idx].qty) || 1) - 1);
            saveCart(items);
            updateCartUI();
          }
        });
        $("#cartItems").on("click", ".btn-del", function () {
          const idx = Number($(this).data("index"));
          const items = loadCart();
          if (Number.isInteger(idx)) {
            items.splice(idx, 1);
            saveCart(items);
            updateCartUI();
          }
        });
        $("#clearCart").on("click", function () {
          saveCart([]);
          updateCartUI();
        });
        $("#cartPanel").on("click", ".btn.btn-primary.w-50", function () {
          window.location.href = "checkout.html";
        });
      });
    </script>
  </body>
</html>
